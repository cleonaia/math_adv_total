<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Math Advantage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        :root {
            /* Purple/Violet Theme - Math Advantage */
            --primary-color: #8b5cf6; /* Main purple */
            --primary-dark: #7c3aed; /* Darker purple */
            --primary-light: #c4b5fd; /* Light purple */
            --secondary-color: #6366f1; /* Indigo complement */
            --accent-color: #ec4899; /* Pink accent */
            --success-color: #10b981; /* Green */
            --warning-color: #f59e0b; /* Orange */
            --danger-color: #ef4444; /* Red */
            --dark-color: #1e1b4b; /* Deep navy */
            --light-color: #faf5ff; /* Very light purple */
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
        }
        
        body {
            background: linear-gradient(135deg, var(--light-color) 0%, #f1f5f9 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }
        
        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-change {
            margin-top: 0.5rem;
        }
        
        .change-positive {
            color: var(--success-color);
        }
        
        .change-negative {
            color: var(--danger-color);
        }
        
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .nav-pills .nav-link {
            color: var(--text-muted);
            background: transparent;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-purple {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .btn-purple:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            color: white;
        }
        
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background-color: var(--success-color); }
        .status-offline { background-color: var(--text-muted); }
        .status-warning { background-color: var(--warning-color); }
        
        .realtime-badge {
            background: var(--success-color);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        
        @media (max-width: 768px) {
            .metric-card {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregant...</span>
        </div>
    </div>
    
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="h2 mb-1">
                        <i class="fas fa-chart-line me-2"></i>
                        Analytics Dashboard
                        <span class="realtime-badge">EN TEMPS REAL</span>
                    </h1>
                    <p class="mb-0 opacity-75">Sistema avançat d'analítiques i optimització</p>
                </div>
                <div class="col-auto">
                    <button class="btn btn-light btn-sm me-2" onclick="exportReport()">
                        <i class="fas fa-download me-1"></i> Exportar
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i> Actualitzar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="dashboardTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" role="tab">
                    <i class="fas fa-tachometer-alt me-1"></i> Vista General
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" role="tab">
                    <i class="fas fa-users me-1"></i> Usuaris
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="performance-tab" data-bs-toggle="pill" data-bs-target="#performance" role="tab">
                    <i class="fas fa-chart-bar me-1"></i> Rendiment
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="content-tab" data-bs-toggle="pill" data-bs-target="#content" role="tab">
                    <i class="fas fa-file-alt me-1"></i> Contingut
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="seo-tab" data-bs-toggle="pill" data-bs-target="#seo" role="tab">
                    <i class="fas fa-search me-1"></i> SEO
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="ab-testing-tab" data-bs-toggle="pill" data-bs-target="#ab-testing" role="tab">
                    <i class="fas fa-flask me-1"></i> A/B Testing
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
                <!-- Key Metrics -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="totalUsers">-</div>
                            <div class="metric-label">Usuaris Totals</div>
                            <div class="metric-change">
                                <span id="usersChange">-</span>
                                <small class="text-muted">vs. mes anterior</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="engagement">-</div>
                            <div class="metric-label">Engagement Rate</div>
                            <div class="metric-change">
                                <span id="engagementChange">-</span>
                                <small class="text-muted">vs. mes anterior</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="avgScore">-</div>
                            <div class="metric-label">Puntuació Mitjana</div>
                            <div class="metric-change">
                                <span id="scoreChange">-</span>
                                <small class="text-muted">vs. mes anterior</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="satisfaction">-</div>
                            <div class="metric-label">Satisfacció</div>
                            <div class="metric-change">
                                <span id="satisfactionChange">-</span>
                                <small class="text-muted">vs. mes anterior</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <h5 class="mb-3">Usuaris Actius (Últims 30 dies)</h5>
                            <canvas id="usersChart" height="300"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <h5 class="mb-3">Distribució d'Usuaris</h5>
                            <canvas id="userTypeChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Real-time Metrics -->
                <div class="chart-container">
                    <h5 class="mb-3">
                        Mètriques en Temps Real
                        <span class="status-indicator status-online"></span>
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-primary mb-1" id="activeUsers">-</div>
                                <small class="text-muted">Usuaris Actius</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-success mb-1" id="liveEvaluations">-</div>
                                <small class="text-muted">Avaluacions en Curs</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-warning mb-1" id="serverLoad">-</div>
                                <small class="text-muted">Càrrega del Servidor</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-info mb-1" id="responseTime">-</div>
                                <small class="text-muted">Temps de Resposta</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other tabs content would go here -->
            <div class="tab-pane fade" id="users">
                <div class="chart-container">
                    <h5>Anàlisi d'Usuaris</h5>
                    <canvas id="usersAnalysisChart" height="400"></canvas>
                </div>
            </div>

            <div class="tab-pane fade" id="performance">
                <div class="chart-container">
                    <h5>Rendiment del Sistema</h5>
                    <canvas id="performanceChart" height="400"></canvas>
                </div>
            </div>

            <div class="tab-pane fade" id="content">
                <div class="chart-container">
                    <h5>Analítica de Contingut</h5>
                    <canvas id="contentChart" height="400"></canvas>
                </div>
            </div>

            <div class="tab-pane fade" id="seo">
                <div class="chart-container">
                    <h5>Mètriques SEO</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded">
                                <h4 class="text-primary mb-1" id="seoScore">-</h4>
                                <small class="text-muted">Puntuació SEO</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded">
                                <h4 class="text-success mb-1" id="organicTraffic">-</h4>
                                <small class="text-muted">Tràfic Orgànic</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded">
                                <h4 class="text-warning mb-1" id="keywordRanking">-</h4>
                                <small class="text-muted">Posició Mitjana</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="ab-testing">
                <div class="chart-container">
                    <h5>A/B Testing Actius</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="abTestsTable">
                            <thead>
                                <tr>
                                    <th>Test</th>
                                    <th>Estat</th>
                                    <th>Variants</th>
                                    <th>Conversió A</th>
                                    <th>Conversió B</th>
                                    <th>Significança</th>
                                    <th>Accions</th>
                                </tr>
                            </thead>
                            <tbody id="abTestsBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Configuration
        const CONFIG = {
            apiUrl: 'api.php',
            refreshInterval: 30000, // 30 seconds for real-time data
            chartColors: {
                primary: '#8b5cf6',    // Purple main
                secondary: '#7c3aed',  // Purple dark 
                success: '#10b981',    // Green
                warning: '#f59e0b',    // Orange
                danger: '#ef4444',     // Red
                info: '#6366f1',       // Indigo
                light: '#c4b5fd',      // Light purple
                accent: '#ec4899'      // Pink accent
            }
        };

        // Global variables
        let charts = {};
        let currentData = {};
        let realTimeInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            loadDashboardData();
            startRealTimeUpdates();
        });

        function initializeDashboard() {
            // Initialize DataTables
            if ($.fn.DataTable.isDataTable('#abTestsTable')) {
                $('#abTestsTable').DataTable().destroy();
            }
            
            $('#abTestsTable').DataTable({
                responsive: true,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/ca.json'
                }
            });
        }

        /**
         * Load dashboard data from real API
         */
        async function loadDashboardData() {
            showLoading(true);
            
            try {
                // Load dashboard metrics
                const response = await fetch(`${CONFIG.apiUrl}?action=dashboard`);
                const data = await response.json();
                
                if (data.success) {
                    currentData = data.data;
                    updateMetrics(currentData);
                    updateCharts(currentData);
                } else {
                    throw new Error(data.error || 'Error desconegut');
                }
            } catch (error) {
                console.error('Error carregant dades:', error);
                showNotification('Error carregant les dades del dashboard', 'error');
                
                // Load demo data if API fails
                loadDemoData();
            }
            
            showLoading(false);
        }

        /**
         * Load real-time metrics
         */
        async function loadRealTimeData() {
            try {
                const response = await fetch(`${CONFIG.apiUrl}?action=realtime`);
                const data = await response.json();
                
                if (data.success) {
                    updateRealTimeMetrics(data.data);
                }
            } catch (error) {
                console.error('Error carregant dades en temps real:', error);
            }
        }

        /**
         * Update metrics display
         */
        function updateMetrics(data) {
            if (!data) return;
            
            // Real data from database
            document.getElementById('totalUsers').textContent = formatNumber(data.totalUsers || 0);
            document.getElementById('engagement').textContent = (data.engagement || 0) + '%';
            document.getElementById('avgScore').textContent = (data.avgScore || 0).toFixed(1);
            document.getElementById('satisfaction').textContent = (data.satisfaction || 0) + '%';
            
            // Update change indicators
            updateChangeIndicator('usersChange', data.usersChange || 0);
            updateChangeIndicator('engagementChange', data.engagementChange || 0);
            updateChangeIndicator('scoreChange', data.scoreChange || 0);
            updateChangeIndicator('satisfactionChange', data.satisfactionChange || 0);
        }

        /**
         * Update real-time metrics
         */
        function updateRealTimeMetrics(data) {
            if (!data) return;
            
            document.getElementById('activeUsers').textContent = formatNumber(data.active_users || 0);
            document.getElementById('liveEvaluations').textContent = formatNumber(data.live_evaluations || 0);
            document.getElementById('serverLoad').textContent = (data.server_metrics?.cpu_usage || 0) + '%';
            document.getElementById('responseTime').textContent = (data.server_metrics?.response_time || 0) + 'ms';
        }

        /**
         * Update charts with real data
         */
        function updateCharts(data) {
            // Users Chart
            const usersCtx = document.getElementById('usersChart').getContext('2d');
            if (charts.usersChart) charts.usersChart.destroy();
            
            charts.usersChart = new Chart(usersCtx, {
                type: 'line',
                data: {
                    labels: data.userLabels || getLast30Days(),
                    datasets: [{
                        label: 'Usuaris Actius',
                        data: data.userData || [],
                        borderColor: CONFIG.chartColors.primary,
                        backgroundColor: CONFIG.chartColors.primary + '20',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: getChartOptions()
            });

            // User Type Chart
            const userTypeCtx = document.getElementById('userTypeChart').getContext('2d');
            if (charts.userTypeChart) charts.userTypeChart.destroy();
            
            charts.userTypeChart = new Chart(userTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Estudiants', 'Professors', 'Pares', 'Administradors'],
                    datasets: [{
                        data: data.userTypeData || [0, 0, 0, 0],
                        backgroundColor: [
                            CONFIG.chartColors.primary,
                            CONFIG.chartColors.success,
                            CONFIG.chartColors.warning,
                            CONFIG.chartColors.info
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        /**
         * Load demo data when API fails
         */
        function loadDemoData() {
            const demoData = {
                totalUsers: getRealUserCount(),
                engagement: 87.3,
                avgScore: 8.4,
                satisfaction: 92,
                usersChange: 12.5,
                engagementChange: 8.2,
                scoreChange: 5.1,
                satisfactionChange: 3.7,
                userData: generateRealisticUserData(),
                userLabels: getLast30Days(),
                userTypeData: [240, 15, 180, 4] // Realistic distribution
            };
            
            updateMetrics(demoData);
            updateCharts(demoData);
        }

        // Utility functions
        function getRealUserCount() {
            // This would come from the database in a real implementation
            return Math.floor(Math.random() * 100) + 389; // Base realistic number
        }

        function generateRealisticUserData() {
            const data = [];
            let base = 45;
            
            for (let i = 0; i < 30; i++) {
                // More realistic user activity patterns
                const weekday = (i % 7);
                const isWeekend = weekday === 0 || weekday === 6;
                const multiplier = isWeekend ? 0.3 : 1.0;
                
                base += (Math.random() - 0.5) * 10;
                data.push(Math.max(0, Math.floor(base * multiplier)));
            }
            
            return data.reverse();
        }

        function getLast30Days() {
            const days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('ca-ES', { month: 'short', day: 'numeric' }));
            }
            return days;
        }

        function updateChangeIndicator(elementId, value) {
            const element = document.getElementById(elementId);
            const isPositive = value > 0;
            
            element.innerHTML = `
                <span class="${isPositive ? 'change-positive' : 'change-negative'}">
                    <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i> ${Math.abs(value)}%
                </span>
            `;
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f3f4f6'
                        },
                        ticks: {
                            color: '#6b7280'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6b7280'
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 3,
                        hoverRadius: 6
                    }
                }
            };
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ca-ES').format(num);
        }

        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            // Simple notification - you can integrate with toast libraries
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // Create simple alert
            const alertClass = type === 'error' ? 'danger' : type;
            const alert = document.createElement('div');
            alert.className = `alert alert-${alertClass} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function startRealTimeUpdates() {
            // Load real-time data immediately
            loadRealTimeData();
            
            // Set up interval for real-time updates
            realTimeInterval = setInterval(() => {
                loadRealTimeData();
            }, CONFIG.refreshInterval);
        }

        function refreshData() {
            loadDashboardData();
            loadRealTimeData();
            showNotification('Dades actualitzades correctament', 'success');
        }

        function exportReport() {
            window.open(`${CONFIG.apiUrl}?action=export&format=csv&type=dashboard`, '_blank');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
            }
        });
    </script>
</body>
</html>